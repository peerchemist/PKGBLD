#!/bin/sh
# postinst script for peerbox
#
# see: dh_installdeb(1)

intro() {
	echo "
	 _____               _               
	|  __ \             | |              
	| |__) |__  ___ _ __| |__   _____  __
	|  ___/ _ \/ _ \ '__| '_ \ / _ \ \/ /
	| |  |  __/  __/ |  | |_) | (_) >  < 
	|_|   \___|\___|_|  |_.__/ \___/_/\_\ "

	echo "
	  version: 0.6.4
	  url: www.peerbox.me
	  forum: https://www.peercointalk.org/index.php?board=68.0
	  git: https://github.com/peerchemist/Peerbox
	  chat: https://peercoin.chat/channel/peerbox
	"	
}

conf() {
    peerboxuser()

	echo "Configuring .ppcoin directory for each user..."
	for _HOME in /home/*?; do
		# Obtain the username
		USER=$( basename ${_HOME} )

		if [ ! -d "$_HOME/.ppcoin" ]; then
			echo "Peercoin directory not found for user $USER! Creating one now."
			mkdir $_HOME/.ppcoin
		fi

		if [ ! -f $_HOME/.ppcoin/ppcoin.conf ]; then
			echo "Peercoin configuration file not found for user $USER! Creating one now."
			echo "rpcuser=rpcuser\nrpcpassword=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 24 | head -n 1)" > $_HOME/.ppcoin/ppcoin.conf
			echo "server=1" >> $_HOME/.ppcoin/ppcoin.conf
		fi
		chown -R $USER: $_HOME/.ppcoin
	done

}

rename() {
	if "$HOSTNAME" != "peerbox"; then

			echo "
	Do you want to rename this machine to 'peerbox'?
	This will enable automatic discovery on local network as 'peerbox.local' \n\t[yn] "
			read input
			case "$input" in
			n*|N*)
			    echo "
	Poor misguided one. Why are you installing this, then?"
			;;

			y*|Y*)
			hostnamectl --static set-hostname peerbox
			echo "\nYou should reboot now.\n"
			exit
			;;

			esac
	fi
}

peerboxuser() {
    if ! getent passwd peerbox > /dev/null; then
        adduser --system $quiet --home /home/peerbox \
            --shell /bin/bash --group --gecos "Peerbox administrator" peerbox
    fi
    # if the user was created manually, make sure the group is there as well
    if ! getent group peerbox > /dev/null; then
        addgroup --system $quiet peerbox
    fi
    # make sure peerbox is in the peerbox group
    if ! id -Gn peerbox | grep -qw peerbox; then
        adduser $quiet peerbox peerbox
    fi

    # check validity of peerbox user and group
    if [ "`id -u peerbox`" -eq 0 ]; then
        echo "The peerbox system user must not have uid 0 (root).
Please fix this and reinstall this package." >&2
        exit 1
    fi
    if [ "`id -g peerbox`" -eq 0 ]; then
        echo "The peerbox system user must not have root as primary group.
Please fix this and reinstall this package." >&2
        exit 1
    fi

    # ensure home directory ownership
    mkdir -p /home/peerbox
    chown -R peerbox:peerbox /home/peerbox

    #setuid and setgid bits so ppcoind runs as peerbox user
    chmod u+s /usr/bin/ppcoind
    chmod g+s /usr/bin/ppcoind
    chown peerbox /usr/bin/ppcoind
    chgrp peerbox /usr/bin/ppcoind
}

set -e

case "$1" in
    configure)
	systemctl daemon-reload
	##
	intro
	conf
	rename
	##
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
